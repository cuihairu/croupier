<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Croupier</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; margin: 24px; }
    code { background: #f5f5f5; padding: 2px 4px; }
  </style>
  <script>
    let descriptors = [];
    async function load() {
      const res = await fetch('/api/descriptors');
      descriptors = await res.json();
      const sel = document.getElementById('fn');
      descriptors.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = `${d.id} v${d.version}`;
        sel.appendChild(opt);
      });
      if (descriptors.length > 0) {
        renderForm(descriptors[0]);
      }
    }
    function renderForm(desc){
      const form = document.getElementById('dyn');
      form.innerHTML = '';
      const props = (desc.params && desc.params.properties) || {};
      for (const [k,v] of Object.entries(props)){
        const label = document.createElement('label'); label.textContent = k;
        const input = document.createElement('input'); input.id = 'f_'+k; input.style.width='300px';
        form.appendChild(label); form.appendChild(document.createElement('br'));
        form.appendChild(input); form.appendChild(document.createElement('br'));
      }
      // sync to textarea as JSON
      const payload = {}; for (const k of Object.keys(props)){ payload[k] = ''; }
      document.getElementById('payload').value = JSON.stringify(payload, null, 2);
    }
    document.addEventListener('change', (e)=>{
      if (!e.target.id || !e.target.id.startsWith('f_')) return;
      const txt = document.getElementById('payload').value;
      let obj = {}; try { obj = JSON.parse(txt) } catch(e) {}
      obj[e.target.id.slice(2)] = e.target.value;
      document.getElementById('payload').value = JSON.stringify(obj, null, 2);
    });
    async function invoke() {
      const fn = document.getElementById('fn').value;
      const body = document.getElementById('payload').value;
      let payload = {};
      try { payload = JSON.parse(body); } catch (e) { alert('JSON 无效'); return }
      const res = await fetch('/api/invoke', {method:'POST', headers:{'Content-Type':'application/json','X-User':'user:dev'}, body: JSON.stringify({function_id: fn, payload})});
      const txt = await res.text();
      document.getElementById('result').textContent = txt || '(no content)';
    }
    window.onload = load;
  </script>
  </head>
<body>
  <h1>Croupier</h1>
  <p>执行函数：</p>
  <div>
    <label>Function:</label>
    <select id="fn"></select>
  </div>
  <div>
    <label>Payload:</label>
    <textarea id="payload" style="width: 480px; height: 120px;"></textarea>
  </div>
  <div id="dyn"></div>
  <button onclick="invoke()">Invoke</button>
  <button onclick="startJob()">Start Job</button>
  <button onclick="cancelJob()">Cancel Job</button>
  <pre id="result"></pre>
  <script>
    async function startJob(){
      const fn = document.getElementById('fn').value;
      const body = document.getElementById('payload').value;
      let payload = {};
      try { payload = JSON.parse(body); } catch (e) { alert('JSON 无效'); return }
      const res = await fetch('/api/start_job', {method:'POST', headers:{'Content-Type':'application/json','X-User':'user:dev'}, body: JSON.stringify({function_id: fn, payload})});
      if (!res.ok) { alert('start job failed'); return }
      const j = await res.json();
      window.currentJobId = j.job_id;
      const es = new EventSource('/api/stream_job?id='+encodeURIComponent(j.job_id));
      es.onmessage = (e)=>{ document.getElementById('result').textContent += e.data + "\n"; };
      es.addEventListener('done', ()=> es.close());
      es.addEventListener('error', ()=> es.close());
    }
    async function cancelJob(){
      if (!window.currentJobId) { alert('no job'); return }
      await fetch('/api/cancel_job', {method:'POST', headers:{'Content-Type':'application/json','X-User':'user:dev'}, body: JSON.stringify({job_id: window.currentJobId})});
    }
  </script>
</body>
</html>
