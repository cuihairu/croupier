name: Release (Tag)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-go:
    name: Build Go Binaries (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: Setup buf
        if: runner.os != 'Windows'
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Build protoc-gen-croupier
        if: runner.os != 'Windows'
        run: make croupier-plugin
      - name: Generate proto
        if: runner.os != 'Windows'
        run: buf generate
      - name: Go mod download
        run: go mod download
      - name: Build (Linux/Mac)
        if: runner.os != 'Windows'
        run: make build
      - name: Build (Windows, PowerShell)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path bin | Out-Null
          $VERSION = (git describe --tags --always --dirty)
          $BUILD_TIME = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd_HH:mm:ss")
          $LDFLAGS = "-X main.version=$VERSION -X main.buildTime=$BUILD_TIME -s -w"
          go build -tags "pg sqlite" -ldflags "$LDFLAGS" -o bin/croupier-server.exe ./services/server
          go build -ldflags "$LDFLAGS" -o bin/croupier-agent.exe ./services/agent-stdlib
          go build -ldflags "$LDFLAGS" -o bin/croupier-edge.exe ./services/edge-stdlib
      - name: Package binaries (Linux/Mac, tar.gz with OS/ARCH)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p release
          GOOS=$(go env GOOS)
          GOARCH=$(go env GOARCH)
          TAR="release/croupier-bin-${GOOS}-${GOARCH}.tar.gz"
          tar -czf "${TAR}" -C bin .
      - name: Package binaries (Windows, zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release | Out-Null
          $GOOS = (go env GOOS)
          $GOARCH = (go env GOARCH)
          $ZIP = "release/croupier-bin-$GOOS-$GOARCH.zip"
          Compress-Archive -Path bin/* -DestinationPath $ZIP -Force
      - name: Upload artifact (binaries)
        uses: actions/upload-artifact@v4
        with:
          name: croupier-binaries-${{ matrix.os }}
          path: release/*
          if-no-files-found: error

  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
            node-version: 22
            cache: 'pnpm'
            cache-dependency-path: dashboard/pnpm-lock.yaml
      - name: Install deps
        working-directory: dashboard
        run: pnpm install --frozen-lockfile
      - name: Build dashboard
        working-directory: dashboard
        run: pnpm run build
      - name: Package dashboard (zip)
        run: |
          cd dashboard
          zip -r ../dashboard-dist.zip dist
      - name: Upload artifact (dashboard)
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-dist
          path: dashboard-dist.zip
          if-no-files-found: error

  build-sdks:
    name: Build SDKs
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sdk: [go, java, js, python, cpp]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Node.js
        if: matrix.sdk == 'js'
        uses: actions/setup-node@v4
        with:
            node-version: 22
      - name: Setup Go
        if: matrix.sdk == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Setup Java
        if: matrix.sdk == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Setup Python
        if: matrix.sdk == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Python build tools
        if: matrix.sdk == 'python'
        run: |
          python -m pip install --upgrade pip
          pip install build
      - name: Build SDK (Go)
        if: matrix.sdk == 'go'
        working-directory: sdks/go
        run: |
          go mod tidy
          go build ./...
          tar -czf ../../sdk-go-src.tar.gz .
      - name: Build SDK (Java)
        if: matrix.sdk == 'java'
        working-directory: sdks/java
        run: |
          ./gradlew --no-daemon build -x test
          mkdir -p ../../release-sdks/java
          cp -r build/libs ../../release-sdks/java/
      - name: Setup pnpm (JS)
        if: matrix.sdk == 'js'
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node.js (JS)
        if: matrix.sdk == 'js'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: sdks/js/pnpm-lock.yaml
      - name: Build SDK (JS)
        if: matrix.sdk == 'js'
        working-directory: sdks/js
        run: |
          pnpm install --frozen-lockfile
          pnpm run build
          mkdir -p ../../release-sdks/js
          cp -r dist ../../release-sdks/js/
      - name: Build SDK (Python)
        if: matrix.sdk == 'python'
        working-directory: sdks/python
        run: |
          python -m build
          mkdir -p ../../release-sdks/python
          cp -r dist ../../release-sdks/python/
      - name: Build SDK (C++)
        if: matrix.sdk == 'cpp'
        shell: bash
        working-directory: sdks/cpp
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config libprotobuf-dev protobuf-compiler
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_GRPC=ON
          cmake --build build --parallel
          mkdir -p ../../release-sdks/cpp
          cp -r build ../../release-sdks/cpp/
      - name: Package SDK artifact
        run: |
          if [ -d release-sdks ]; then
            tar -czf release-sdks.tar.gz -C release-sdks .
          fi
      - name: Upload artifact (sdks)
        uses: actions/upload-artifact@v4
        with:
          name: sdks
          path: |
            sdk-go-src.tar.gz
            release-sdks.tar.gz
          if-no-files-found: warn

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-go, build-dashboard, build-sdks]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
