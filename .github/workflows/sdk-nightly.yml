name: SDK Nightly Release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # daily at 03:00 UTC

concurrency:
  group: sdk-nightly-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  actions: write

env:
  NIGHTLY_TAG: sdk-nightly

jobs:

  # --------------- C++ SDK (static lib) ---------------
  cpp:
    name: cpp (${{ matrix.name }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-x64
            runs-on: ubuntu-latest
            triplet: x64-linux
            os_label: linux
            arch: x86_64
          - name: ubuntu-arm64
            runs-on: ubuntu-24.04-arm64
            triplet: arm64-linux
            os_label: linux
            arch: arm64
            allow_fail: true
          - name: macos-x64
            runs-on: macos-15-intel
            triplet: x64-osx
            os_label: macos
            arch: x86_64
          - name: macos-arm64
            runs-on: macos-latest
            triplet: arm64-osx
            os_label: macos
            arch: arm64
          - name: windows-x64
            runs-on: windows-latest
            triplet: x64-windows-static
            os_label: windows
            arch: x86_64
    runs-on: ${{ matrix.runs-on }}
    continue-on-error: ${{ matrix.allow_fail == true }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install Ninja (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y ninja-build
          elif command -v brew >/dev/null 2>&1; then
            brew update || true
            brew install ninja || true
          fi

      - name: Install vcpkg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          VCPKG_ROOT="$PWD/.vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          # Cache vcpkg downloads to speed up subsequent runs
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> "$GITHUB_ENV"
          # Build only Release binaries for ports to halve build time
          echo "VCPKG_BUILD_TYPE=release" >> "$GITHUB_ENV"

      - name: Create nuget.config (GitHub Packages) [Unix]
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # On Unix runners, avoid NuGet provider to prevent mono dependency.
          # Use local 'files' binary cache only; we still cache it via actions/cache.
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_ROOT/archives,readwrite" >> "$GITHUB_ENV"

      - name: Set vcpkg concurrency (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          CORES="$( (command -v nproc >/dev/null 2>&1 && nproc) || (command -v sysctl >/dev/null 2>&1 && sysctl -n hw.ncpu) || echo 2 )"
          echo "VCPKG_MAX_CONCURRENCY=$CORES" >> "$GITHUB_ENV"

      - name: Install aria2 (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y aria2 || true
          elif command -v brew >/dev/null 2>&1; then
            brew update || true
            brew install aria2 || true
          fi
      - name: Cache vcpkg downloads
        uses: actions/cache@v4
        with:
          path: .vcpkg/downloads
          key: vcpkg-downloads-${{ runner.os }}-${{ matrix.triplet }}
          restore-keys: |
            vcpkg-downloads-${{ runner.os }}-
      - name: Cache vcpkg archives (Unix)
        if: runner.os != 'Windows'
        uses: actions/cache@v4
        with:
          path: .vcpkg/archives
          key: vcpkg-archives-${{ runner.os }}-${{ matrix.triplet }}
          restore-keys: |
            vcpkg-archives-${{ runner.os }}-
      - name: Bootstrap and install ports (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          VCPKG_ROOT="$PWD/.vcpkg"
          "$VCPKG_ROOT/bootstrap-vcpkg.sh" -disableMetrics
          # Pin builtin-baseline in manifest to the cloned vcpkg commit
          BASELINE="$("$VCPKG_ROOT"/git-2*/bin/git rev-parse HEAD 2>/dev/null || git -C "$VCPKG_ROOT" rev-parse HEAD)"
          sed -i.bak "s/__VCPKG_BASELINE__/${BASELINE}/" sdks/cpp/vcpkg.json || true
          # Preinstall via manifest to warm cache.
          # In manifest mode, avoid positional package args; set default triplet via env.
          export VCPKG_DEFAULT_TRIPLET=${{ matrix.triplet }}
          (cd sdks/cpp && "$VCPKG_ROOT/vcpkg" install) || true
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> "$GITHUB_ENV"

      - name: Install vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:VCPKG_ROOT="$PWD\.vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          # Build only Release binaries for ports to halve build time
          echo "VCPKG_BUILD_TYPE=release" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          # Configure NuGet-based binary caching (GitHub Packages) with files fallback
          $owner = "${{ github.repository_owner }}"
          $token = "${{ secrets.GITHUB_TOKEN }}"
          $nuget = @"
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <packageSources>
              <add key="github" value="https://nuget.pkg.github.com/$owner/index.json" />
            </packageSources>
            <packageSourceCredentials>
              <github>
                <add key="Username" value="$owner" />
                <add key="ClearTextPassword" value="$token" />
              </github>
            </packageSourceCredentials>
          </configuration>
          "@
          # Write NuGet config to the default location so nuget.exe can discover it implicitly
          $nugetDir = Join-Path $env:APPDATA "NuGet"
          New-Item -ItemType Directory -Force -Path $nugetDir | Out-Null
          $nugetPath = Join-Path $nugetDir "NuGet.Config"
          $nuget | Out-File -FilePath $nugetPath -Encoding UTF8
          # Use 'nuget,<url>' provider so vcpkg passes -Source explicitly; credentials resolved from NuGet.Config
          echo "VCPKG_BINARY_SOURCES=clear;nuget,https://nuget.pkg.github.com/$owner/index.json,readwrite;files,$env:VCPKG_ROOT\archives,readwrite" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          # Remove any workspace-level nuget.config to avoid older runs influencing nuget.exe
          if (Test-Path \"$env:GITHUB_WORKSPACE\\nuget.config\") { Remove-Item \"$env:GITHUB_WORKSPACE\\nuget.config\" -Force }

      - name: Diagnostics (Windows NuGet/vcpkg)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host \"VCPKG_BINARY_SOURCES=$env:VCPKG_BINARY_SOURCES\"
          if (Get-Command nuget.exe -ErrorAction SilentlyContinue) {
            nuget sources list -NonInteractive -Verbosity detailed
            Write-Host \"NuGet.Config location:\" (Join-Path $env:APPDATA \"NuGet\\NuGet.Config\")
            if (Test-Path \"$env:GITHUB_WORKSPACE\\nuget.config\") {
              Write-Host \"Warning: found workspace nuget.config; removing to avoid conflicts\"
              Remove-Item \"$env:GITHUB_WORKSPACE\\nuget.config\" -Force
            }
          } else {
            Write-Host \"nuget.exe not found in PATH\"
          }

      - name: Set vcpkg concurrency (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $cores = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
          if (-not $cores) { $cores = 2 }
          echo "VCPKG_MAX_CONCURRENCY=$cores" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install aria2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install aria2 -y || echo "aria2 install skipped"
      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja -y || echo "ninja install skipped"
      - name: Cache vcpkg downloads (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: .vcpkg\downloads
          key: vcpkg-downloads-${{ runner.os }}-${{ matrix.triplet }}
          restore-keys: |
            vcpkg-downloads-${{ runner.os }}-
      - name: Cache vcpkg archives (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: .vcpkg\archives
          key: vcpkg-archives-${{ runner.os }}-${{ matrix.triplet }}
          restore-keys: |
            vcpkg-archives-${{ runner.os }}-
      - name: Bootstrap and install ports (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:VCPKG_ROOT="$PWD\.vcpkg"
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
          $baseline = git -C $env:VCPKG_ROOT rev-parse HEAD
          (Get-Content sdks/cpp/vcpkg.json).Replace("__VCPKG_BASELINE__", $baseline) | Set-Content sdks/cpp/vcpkg.json
          pushd sdks/cpp
          # Preinstall via manifest to warm cache.
          # In manifest mode, avoid positional package args; set default triplet via env.
          $env:VCPKG_DEFAULT_TRIPLET = "${{ matrix.triplet }}"
          & "$env:VCPKG_ROOT\vcpkg.exe" install
          if ($LASTEXITCODE -ne 0) {
            Write-Host "manifest preinstall skipped (non-zero exit code $LASTEXITCODE)"
            $global:LASTEXITCODE = 0
          }
          popd
          echo "VCPKG_ROOT=$env:VCPKG_ROOT" >> $env:GITHUB_ENV

      - name: Configure (Release, static)
        shell: bash
        run: |
          cmake -S sdks/cpp -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} \
            -DVCPKG_MANIFEST_MODE=ON \
            -DVCPKG_FEATURE_FLAGS=manifests,binarycaching \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"

      - name: Cache vcpkg_installed (manifest)
        uses: actions/cache@v4
        with:
          path: sdks/cpp/vcpkg_installed
          key: vcpkg-installed-${{ runner.os }}-${{ matrix.triplet }}-${{ hashFiles('sdks/cpp/vcpkg.json') }}
          restore-keys: |
            vcpkg-installed-${{ runner.os }}-${{ matrix.triplet }}-

      - name: Build static library
        shell: bash
        run: |
          # Use max available cores (default to 2 if not detected)
          CORES="${VCPKG_MAX_CONCURRENCY:-}"
          if [ -z "$CORES" ]; then
            CORES="$( (command -v nproc >/dev/null 2>&1 && nproc) || (command -v sysctl >/dev/null 2>&1 && sysctl -n hw.ncpu) || echo 2 )"
          fi
          cmake --build build --config Release --target croupier-sdk-static -j "$CORES"

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          PKG="croupier-cpp-sdk-${{ matrix.os_label }}-${{ matrix.arch }}-static"
          mkdir -p "out/${PKG}/include" "out/${PKG}/lib"
          mkdir -p "out/${PKG}/cmake"
          cp -R sdks/cpp/include/* "out/${PKG}/include/"
          if [ -d sdks/cpp/generated ]; then
            mkdir -p "out/${PKG}/include/generated"
            cp -R sdks/cpp/generated/* "out/${PKG}/include/generated/"
          fi
          # Find built lib (platform-specific name; handle libcroupier-sdk.a or libcroupier-sdk-static.a)
          libfile="$(find build -type f \( -name 'libcroupier-sdk-static.*' -o -name 'libcroupier-sdk.*' -o -name 'croupier-sdk-static.lib' -o -name 'croupier-sdk.lib' \) | head -n1 || true)"
          if [ -z "${libfile}" ]; then
            echo "Static library not found"
            ls -R build || true
            echo "Debug: listing candidate archives"
            find build -type f \( -name '*.a' -o -name '*.lib' \) -maxdepth 5 -print || true
            exit 1
          fi
          cp "${libfile}" "out/${PKG}/lib/"
          LIBNAME="$(basename "${libfile}")"
          # Generate a minimal CMake package config for find_package(croupier-sdk)
          cat > "out/${PKG}/cmake/croupier-sdk-config.cmake" <<EOF
          # Auto-generated config for croupier-sdk (nightly)
          set(_CROUPIER_SDK_PREFIX "\${CMAKE_CURRENT_LIST_DIR}/..")
          if (NOT TARGET croupier-sdk-static)
            add_library(croupier-sdk-static STATIC IMPORTED)
            set_target_properties(croupier-sdk-static PROPERTIES
              IMPORTED_LOCATION "\${_CROUPIER_SDK_PREFIX}/lib/${LIBNAME}"
              INTERFACE_INCLUDE_DIRECTORIES "\${_CROUPIER_SDK_PREFIX}/include"
            )
          endif()
          if (NOT TARGET croupier::sdk-static)
            add_library(croupier::sdk-static ALIAS croupier-sdk-static)
          endif()
          if (NOT TARGET croupier::sdk)
            add_library(croupier::sdk ALIAS croupier-sdk-static)
          endif()
          EOF
          cp sdks/cpp/README.md "out/${PKG}/" || true
          cp sdks/cpp/LICENSE "out/${PKG}/" 2>/dev/null || true
          (cd out && tar czf "${PKG}.tar.gz" "${PKG}")
          echo "PACKAGE_NAME=${PKG}" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: out/${{ env.PACKAGE_NAME }}.tar.gz
          if-no-files-found: error
          retention-days: 7

  # --------------- Java SDK (Jar) ---------------
  java:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
      - name: Build JAR (Gradle)
        run: |
          gradle -p sdks/java clean build -x test
      - name: Collect and upload
        run: |
          mkdir -p out
          # Copy the built jar to a stable filename
          set -euo pipefail
          JAR=""
          if ls sdks/java/build/libs/croupier-java-sdk-*.jar >/dev/null 2>&1; then
            JAR=$(ls -1 sdks/java/build/libs/croupier-java-sdk-*.jar | head -n1)
          elif ls sdks/java/build/libs/*.jar >/dev/null 2>&1; then
            JAR=$(ls -1 sdks/java/build/libs/*.jar | head -n1)
          fi
          if [ -z "${JAR}" ]; then
            echo "No jar found under sdks/java/build/libs"
            ls -R sdks/java/build || true
            exit 1
          fi
          cp "${JAR}" "out/croupier-java-sdk.jar"
        shell: bash
      - uses: actions/upload-artifact@v4
        with:
          name: croupier-java-sdk
          path: out/croupier-java-sdk.jar
          if-no-files-found: error
          retention-days: 7

  # --------------- Python SDK (wheel + sdist) ---------------
  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Build wheel
        run: |
          python -m pip install --upgrade pip build
          # Build wheel only to avoid sdist requiring requirements.txt in setup.py
          python -m build --wheel sdks/python
          # Add stable aliases for convenience downloads
          mkdir -p sdks/python/out
          WHL=$(ls sdks/python/dist/*.whl | head -n1 || true)
          if [ -n "${WHL}" ]; then
            cp "${WHL}" sdks/python/out/croupier-python-sdk.whl
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: croupier-python-sdk
          path: |
            sdks/python/dist/*.whl
            sdks/python/out/croupier-python-sdk.whl
          if-no-files-found: error
          retention-days: 7

  # --------------- JavaScript SDK (npm package) ---------------
  js:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Pack npm tarball
        working-directory: sdks/js
        run: |
          npm ci || true
          npm pack
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: croupier-js-sdk
          path: sdks/js/*.tgz
          if-no-files-found: error
          retention-days: 7

  # --------------- Go SDK (source tarball) ---------------
  go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Tarball Go SDK source
        run: |
          mkdir -p out
          tar czf "out/croupier-go-sdk.tar.gz" -C sdks go
      - uses: actions/upload-artifact@v4
        with:
          name: croupier-go-sdk
          path: out/croupier-go-sdk.tar.gz
          if-no-files-found: error
          retention-days: 7

  # --------------- Aggregate release ---------------
  release:
    name: Publish Nightly Release
    needs: [cpp, java, python, js, go]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: List artifacts
        run: ls -R artifacts
      - name: Ensure release exists (sdk-nightly)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if gh release view "${NIGHTLY_TAG}" >/dev/null 2>&1; then
            echo "Release ${NIGHTLY_TAG} exists"
          else
            gh release create "${NIGHTLY_TAG}" -t "SDK Nightly" -n "Auto-updated nightly build. Assets are replaced on each run." -p
          fi
      - name: Upload assets (overwrite)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          shopt -s globstar nullglob
          files=(artifacts/**/*)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No artifacts found"
            exit 1
          fi
          gh release upload "${NIGHTLY_TAG}" "${files[@]}" --clobber
