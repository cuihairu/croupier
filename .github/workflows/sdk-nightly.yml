name: SDK Nightly Release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # daily at 03:00 UTC

concurrency:
  group: sdk-nightly-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

env:
  NIGHTLY_TAG: sdk-nightly

jobs:

  # --------------- C++ SDK (static lib) ---------------
  cpp:
    name: cpp (${{ matrix.name }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-x64
            runs-on: ubuntu-latest
            triplet: x64-linux
            os_label: linux
            arch: x86_64
          - name: ubuntu-arm64
            runs-on: ubuntu-24.04-arm64
            triplet: arm64-linux
            os_label: linux
            arch: arm64
            allow_fail: true
          - name: macos-x64
            runs-on: macos-15-intel
            triplet: x64-osx
            os_label: macos
            arch: x86_64
          - name: macos-arm64
            runs-on: macos-latest
            triplet: arm64-osx
            os_label: macos
            arch: arm64
          - name: windows-x64
            runs-on: windows-latest
            triplet: x64-windows-static
            os_label: windows
            arch: x86_64
    runs-on: ${{ matrix.runs-on }}
    continue-on-error: ${{ matrix.allow_fail == true }}
    env:
      # Enable vcpkg binary caching to GitHub Actions cache provider
      VCPKG_BINARY_SOURCES: clear;x-gha,readwrite
      # Parallelize vcpkg builds
      VCPKG_MAX_CONCURRENCY: ${{ runner.maxParallel }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install vcpkg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          VCPKG_ROOT="$PWD/.vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          # Cache vcpkg downloads to speed up subsequent runs
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> "$GITHUB_ENV"

      - name: Install aria2 (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y aria2 || true
          elif command -v brew >/dev/null 2>&1; then
            brew update || true
            brew install aria2 || true
          fi
      - name: Cache vcpkg downloads
        uses: actions/cache@v4
        with:
          path: .vcpkg/downloads
          key: vcpkg-downloads-${{ runner.os }}-${{ matrix.triplet }}
          restore-keys: |
            vcpkg-downloads-${{ runner.os }}-
      - name: Bootstrap and install ports (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          VCPKG_ROOT="$PWD/.vcpkg"
          "$VCPKG_ROOT/bootstrap-vcpkg.sh" -disableMetrics
          # Pin builtin-baseline in manifest to the cloned vcpkg commit
          BASELINE="$("$VCPKG_ROOT"/git-2*/bin/git rev-parse HEAD 2>/dev/null || git -C "$VCPKG_ROOT" rev-parse HEAD)"
          sed -i.bak "s/__VCPKG_BASELINE__/${BASELINE}/" sdks/cpp/vcpkg.json || true
          # Preinstall via manifest to warm cache
          EXTRA=""
          if command -v aria2c >/dev/null 2>&1; then
            EXTRA="--x-use-aria2"
          fi
          (cd sdks/cpp && "$VCPKG_ROOT/vcpkg" install --triplet ${{ matrix.triplet }} $EXTRA) || true
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> "$GITHUB_ENV"

      - name: Install vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:VCPKG_ROOT="$PWD\.vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg $env:VCPKG_ROOT

      - name: Install aria2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install aria2 -y || echo "aria2 install skipped"
      - name: Cache vcpkg downloads (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: .vcpkg\downloads
          key: vcpkg-downloads-${{ runner.os }}-${{ matrix.triplet }}
          restore-keys: |
            vcpkg-downloads-${{ runner.os }}-
      - name: Bootstrap and install ports (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:VCPKG_ROOT="$PWD\.vcpkg"
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
          $baseline = git -C $env:VCPKG_ROOT rev-parse HEAD
          (Get-Content sdks/cpp/vcpkg.json).Replace("__VCPKG_BASELINE__", $baseline) | Set-Content sdks/cpp/vcpkg.json
          pushd sdks/cpp
          $extra = ""
          if (Get-Command aria2c.exe -ErrorAction SilentlyContinue) { $extra = "--x-use-aria2" }
          & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet ${{ matrix.triplet }} $extra || echo "manifest preinstall skipped"
          popd
          echo "VCPKG_ROOT=$env:VCPKG_ROOT" >> $env:GITHUB_ENV

      - name: Configure (Release, static)
        shell: bash
        run: |
          cmake -S sdks/cpp -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} \
            -DVCPKG_MANIFEST_MODE=ON \
            -DVCPKG_FEATURE_FLAGS=manifests,binarycaching \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"

      - name: Cache vcpkg_installed (manifest)
        uses: actions/cache@v4
        with:
          path: sdks/cpp/vcpkg_installed
          key: vcpkg-installed-${{ runner.os }}-${{ matrix.triplet }}-${{ hashFiles('sdks/cpp/vcpkg.json') }}
          restore-keys: |
            vcpkg-installed-${{ runner.os }}-${{ matrix.triplet }}-

      - name: Build static library
        shell: bash
        run: cmake --build build --config Release --target croupier-sdk-static -j 2

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          PKG="croupier-cpp-sdk-${{ matrix.os_label }}-${{ matrix.arch }}-static"
          mkdir -p "out/${PKG}/include" "out/${PKG}/lib"
          mkdir -p "out/${PKG}/cmake"
          cp -R sdks/cpp/include/* "out/${PKG}/include/"
          if [ -d sdks/cpp/generated ]; then
            mkdir -p "out/${PKG}/include/generated"
            cp -R sdks/cpp/generated/* "out/${PKG}/include/generated/"
          fi
          # Find built lib (platform-specific name)
          libfile=""
          if [ "${{ runner.os }}" = "Windows" ]; then
            libfile=$(ls build/Release/croupier-sdk-static.lib 2>/dev/null || ls build/**/croupier-sdk-static.lib 2>/dev/null || true)
          else
            libfile=$(ls build/**/libcroupier-sdk-static.* 2>/dev/null | head -n1 || true)
          fi
          if [ -z "${libfile}" ]; then
            echo "Static library not found"
            ls -R build || true
            exit 1
          fi
          cp "${libfile}" "out/${PKG}/lib/"
          LIBNAME="$(basename "${libfile}")"
          # Generate a minimal CMake package config for find_package(croupier-sdk)
          cat > "out/${PKG}/cmake/croupier-sdk-config.cmake" <<EOF
          # Auto-generated config for croupier-sdk (nightly)
          set(_CROUPIER_SDK_PREFIX "\${CMAKE_CURRENT_LIST_DIR}/..")
          if (NOT TARGET croupier-sdk-static)
            add_library(croupier-sdk-static STATIC IMPORTED)
            set_target_properties(croupier-sdk-static PROPERTIES
              IMPORTED_LOCATION "\${_CROUPIER_SDK_PREFIX}/lib/${LIBNAME}"
              INTERFACE_INCLUDE_DIRECTORIES "\${_CROUPIER_SDK_PREFIX}/include"
            )
          endif()
          if (NOT TARGET croupier::sdk-static)
            add_library(croupier::sdk-static ALIAS croupier-sdk-static)
          endif()
          if (NOT TARGET croupier::sdk)
            add_library(croupier::sdk ALIAS croupier-sdk-static)
          endif()
          EOF
          cp sdks/cpp/README.md "out/${PKG}/" || true
          cp sdks/cpp/LICENSE "out/${PKG}/" 2>/dev/null || true
          (cd out && tar czf "${PKG}.tar.gz" "${PKG}")
          echo "PACKAGE_NAME=${PKG}" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: out/${{ env.PACKAGE_NAME }}.tar.gz
          if-no-files-found: error
          retention-days: 7

  # --------------- Java SDK (Jar) ---------------
  java:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
      - name: Build JAR (Gradle)
        run: |
          gradle -p sdks/java clean build -x test
      - name: Collect and upload
        run: |
          mkdir -p out
          # Copy the built jar to a stable filename
          set -euo pipefail
          JAR=""
          if ls sdks/java/build/libs/croupier-java-sdk-*.jar >/dev/null 2>&1; then
            JAR=$(ls -1 sdks/java/build/libs/croupier-java-sdk-*.jar | head -n1)
          elif ls sdks/java/build/libs/*.jar >/dev/null 2>&1; then
            JAR=$(ls -1 sdks/java/build/libs/*.jar | head -n1)
          fi
          if [ -z "${JAR}" ]; then
            echo "No jar found under sdks/java/build/libs"
            ls -R sdks/java/build || true
            exit 1
          fi
          cp "${JAR}" "out/croupier-java-sdk.jar"
        shell: bash
      - uses: actions/upload-artifact@v4
        with:
          name: croupier-java-sdk
          path: out/croupier-java-sdk.jar
          if-no-files-found: error
          retention-days: 7

  # --------------- Python SDK (wheel + sdist) ---------------
  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Build wheel
        run: |
          python -m pip install --upgrade pip build
          # Build wheel only to avoid sdist requiring requirements.txt in setup.py
          python -m build --wheel sdks/python
          # Add stable aliases for convenience downloads
          mkdir -p sdks/python/out
          WHL=$(ls sdks/python/dist/*.whl | head -n1 || true)
          if [ -n "${WHL}" ]; then
            cp "${WHL}" sdks/python/out/croupier-python-sdk.whl
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: croupier-python-sdk
          path: |
            sdks/python/dist/*.whl
            sdks/python/out/croupier-python-sdk.whl
          if-no-files-found: error
          retention-days: 7

  # --------------- JavaScript SDK (npm package) ---------------
  js:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Pack npm tarball
        working-directory: sdks/js
        run: |
          npm ci || true
          npm pack
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: croupier-js-sdk
          path: sdks/js/*.tgz
          if-no-files-found: error
          retention-days: 7

  # --------------- Go SDK (source tarball) ---------------
  go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Tarball Go SDK source
        run: |
          mkdir -p out
          tar czf "out/croupier-go-sdk.tar.gz" -C sdks go
      - uses: actions/upload-artifact@v4
        with:
          name: croupier-go-sdk
          path: out/croupier-go-sdk.tar.gz
          if-no-files-found: error
          retention-days: 7

  # --------------- Aggregate release ---------------
  release:
    name: Publish Nightly Release
    needs: [cpp, java, python, js, go]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: List artifacts
        run: ls -R artifacts
      - name: Ensure release exists (sdk-nightly)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if gh release view "${NIGHTLY_TAG}" >/dev/null 2>&1; then
            echo "Release ${NIGHTLY_TAG} exists"
          else
            gh release create "${NIGHTLY_TAG}" -t "SDK Nightly" -n "Auto-updated nightly build. Assets are replaced on each run." -p
          fi
      - name: Upload assets (overwrite)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          shopt -s globstar nullglob
          files=(artifacts/**/*)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No artifacts found"
            exit 1
          fi
          gh release upload "${NIGHTLY_TAG}" "${files[@]}" --clobber
