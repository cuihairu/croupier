# OpenTelemetry Collector配置
# 专为Croupier游戏监控系统设计

receivers:
  # OTLP接收器 - 接收来自Croupier应用的遥测数据
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - "http://localhost:*"
            - "http://127.0.0.1:*"

  # Prometheus接收器 - 接收现有Prometheus指标
  prometheus:
    config:
      scrape_configs:
        - job_name: 'croupier-server'
          static_configs:
            - targets: ['host.docker.internal:8080']
          scrape_interval: 30s
          metrics_path: '/metrics'

processors:
  # 批处理器 - 优化传输效率
  batch:
    timeout: 1s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # 内存限制器 - 防止OOM
  memory_limiter:
    limit_mib: 512
    spike_limit_mib: 128

  # 资源处理器 - 添加游戏特定标签
  resource:
    attributes:
      - key: service.namespace
        value: "croupier"
        action: upsert
      - key: deployment.environment
        from_attribute: "environment"
        action: insert

  # 属性处理器 - 游戏事件增强
  attributes/game:
    actions:
      - key: game.environment
        from_attribute: "environment"
        action: insert
      - key: telemetry.sdk.name
        value: "croupier-otel"
        action: upsert

  # 过滤器 - 过滤敏感数据
  filter/sensitive:
    traces:
      span:
        - 'attributes["user.email"] != nil'
        - 'attributes["user.phone"] != nil'
    metrics:
      metric:
        - 'name == "sensitive_metric"'

exporters:
  # Jaeger导出器 - 链路追踪
  jaeger:
    endpoint: jaeger:14250
    tls:
      insecure: true

  # Prometheus导出器 - 指标
  prometheus:
    endpoint: "0.0.0.0:8888"
    const_labels:
      system: "croupier"

  # OTLP导出器 - 发送到其他系统
  otlp/external:
    endpoint: "${EXTERNAL_OTEL_ENDPOINT}"
    headers:
      api-key: "${EXTERNAL_OTEL_API_KEY}"
    tls:
      insecure: false

  # 日志导出器 - 调试用
  logging:
    loglevel: debug
    sampling_initial: 5
    sampling_thereafter: 200

  # 文件导出器 - 备份
  file:
    path: /tmp/otel-data.json
    rotation:
      max_megabytes: 100
      max_days: 7

service:
  pipelines:
    # 链路追踪流水线
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resource, attributes/game, batch]
      exporters: [jaeger, logging]

    # 指标流水线
    metrics:
      receivers: [otlp, prometheus]
      processors: [memory_limiter, resource, batch]
      exporters: [prometheus, logging]

    # 日志流水线
    logs:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [logging, file]

  extensions: [health_check, pprof, zpages]

extensions:
  # 健康检查
  health_check:
    endpoint: 0.0.0.0:13133

  # 性能分析
  pprof:
    endpoint: 0.0.0.0:1777

  # 调试页面
  zpages:
    endpoint: 0.0.0.0:55679

# 游戏特定配置
processors:
  # 游戏事件丰富处理器
  resource/game_enrichment:
    attributes:
      - key: game.genre
        from_attribute: "game.genre_code"
        action: insert
      - key: game.platform.normalized
        from_attribute: "game.platform"
        action: insert

  # 玩家数据脱敏
  transform/privacy:
    metric_statements:
      - context: metric
        statements:
          - replace_pattern(name, "user\\.id", "user.hash") where name == "game.session.start"

# 告警规则（与Prometheus集成）
processors:
  probabilistic_sampler:
    hash_seed: 22
    sampling_percentage: 15.3