# UI Schema & Views (Web)

This document explains how the Web app renders forms (UI Schema) and output views from packs.

UI Schema
- Source: ui/<function_id>.schema.json (JSON Schema), ui/<function_id>.uischema.json (UI Schema)
- Layout (optional):
  - `ui:layout`: `{ "type": "grid", "cols": 1|2|3|4 }` (default 1)
  - `ui:groups`: `[ { "title": "Group Name", "fields": ["field1","field2",...] }, ... ]`
- Field UI hints (`ui:fields` per field):
  - `label`, `placeholder`, `widget` (input/textarea/select)
  - `enum` and `x-enum-labels` available for select rendering
  - `show_if` / `required_if`: simple expressions using paths and operators `==`, `!=`, `&&`, `||`. Example: `$.type == "advanced" && $.enabled == true`
- Supported types:
  - `string` / `number` / `integer` / `boolean`
  - `array` (adds/removes items)
  - `object` with `properties` (nested group)
  - `object` with `additionalProperties` (map) – UI as key/value entries, submitted as JSON object
- Validation:
  - `minLength` / `maxLength` / `pattern` for strings
  - `minimum` / `maximum` for numbers

Views & Transform
- Descriptor: `outputs.views[]` can specify `renderer`, optional `transform`
- Transform (frontend, safe subset):
  - When `lang` is `cel` (or omitted), expression is treated as a JSON path starting at root (e.g., `$.data.series`)
  - The selected value is passed to the renderer component
  - Path supports simple array indexing via brackets, e.g., `$.value[1]`.
- Built-in renderers:
  - `json.view` – pretty-print JSON
  - `table.basic` – render array of objects as a table
  - `echarts.line` – line chart via ECharts (loaded on demand from CDN). Data accepts Prometheus matrix via `$.data.result` or generic `{ series: [...] }`/`[{ name, data: [[ms,value],...] }]`; options are passed through.

Layout
- Use `outputs.layout` to control multiple views arrangement.
- Example: `{ "type": "grid", "cols": 2 }` renders views in a responsive two-column grid.

Transform Templates (JSON-based)
- Besides `expr`, packs can provide `transform.template` to declaratively reshape data.
- Template strings starting with `$.` are resolved as JSON paths against the current context item; strings starting with `$$.` resolve against the original root.
- Special form: `{ "forEach": { "path": "$.items", "template": { ... } } }` maps arrays.
- Optional filtering: `{ "forEach": { "path": "$.items", "where": { "contains": ["$.name", "prod"] }, "template": { ... } } }`.
- Aliases & helpers:
  - `map`: `{ "map": { "path": "$.items", "template": { ... } } }`
  - `pluck`: `{ "pluck": { "path": "$.items", "value": "$.field" } }`
  - Aggregates: `sum` / `avg` on arrays of values: `{ "sum": { "path": "$.items", "value": "$.v" } }`
  - Value directives: wrap values to coerce/compute
    - `{ "number": "$.v" }` → Number($.v)
    - `{ "msFromSec": "$.ts" }` → seconds to milliseconds
    - `{ "mul": { "value": "$.v", "by": 100 } }`, `{ "div": { "value": "$.v", "by": 1000 } }`
    - `{ "add": { "a": "$.a", "b": 1 } }`, `{ "sub": { "a": "$.a", "b": 1 } }`
    - `{ "toFixed": { "value": "$.v", "digits": 2 } }` → Number fixed decimals
    - `{ "isoFromMs": "$.tsMs" }`, `{ "isoFromSec": "$.tsSec" }` → ISO datetime string

View Conditions
- Optional `show_if` on a view allows hiding the view when the referenced path is falsy or an empty array.
- Example: `{ "id": "table", "show_if": "$.data.items", ... }`.
- Example (Prometheus matrix → ECharts series):
```
{
  "views": [
    {
      "id": "chart",
      "renderer": "echarts.line",
      "transform": {
        "template": {
          "forEach": {
            "path": "$.data.result",
            "template": { "name": "$.metric.instance", "data": "$.values" }
          }
        }
      }
    }
  ]
}
```

Notes
- This is a minimal baseline intended for quick PoC. Full CEL transforms and richer Schema-Form are planned.
- Packs generated by `protoc-gen-croupier` include a default UI Schema with a grid layout and inferred groups.

Plugins
- Built-in renderers are registered in `web/src/plugin/registry.ts`.
- Packs can ship frontend plugins under `web-plugin/*` and reference them in `manifest.json` via `web_plugins`.
- The plugin module must export a default function receiving `{ registerRenderer }` and may register custom renderers.
- Example (Prom pack): `web-plugin/echarts_plugin.js` registers `echarts.bar` and is listed in `manifest.json` → `web_plugins`.
