# æ¸¸æˆæ•°æ®åˆ†æç³»ç»Ÿæ–‡æ¡£

æ¬¢è¿ä½¿ç”¨ Croupier æ¸¸æˆæ•°æ®åˆ†æç³»ç»Ÿï¼æœ¬æ–‡æ¡£å°†å¸®åŠ©æ‚¨äº†è§£å¦‚ä½•æ„å»ºç°ä»£åŒ–çš„æ¸¸æˆæ•°æ®åˆ†æå¹³å°ã€‚

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ
- [æ¸¸æˆæŒ‡æ ‡å…¨æ™¯å›¾](./game-metrics-overview.md) - å®Œæ•´çš„æ¸¸æˆæ•°æ®æŒ‡æ ‡ä½“ç³»
- [æ•°æ®é‡‡é›†æ¶æ„](./data-collection-architecture.md) - å®¢æˆ·ç«¯vsæœåŠ¡å™¨ç«¯é‡‡é›†ç­–ç•¥
- [æ¸¸æˆç±»å‹é€‚é…](./game-type-adaptation.md) - ä¸åŒæ¸¸æˆç±»å‹çš„æŒ‡æ ‡é€‰æ‹©

### ğŸ› ï¸ æŠ€æœ¯å®æ–½
- [OpenTelemetryé›†æˆæŒ‡å—](./opentelemetry-integration.md) - ç°ä»£åŒ–é¥æµ‹è§£å†³æ–¹æ¡ˆ
- [å½“å‰ç³»ç»Ÿåˆ†æ](./current-system-analysis.md) - ç°æœ‰Analyticsç³»ç»Ÿè¯¦è§£
- [ç³»ç»Ÿå¢å¼ºæ–¹æ¡ˆ](./enhancement-plan.md) - å®Œæ•´çš„ç³»ç»Ÿå‡çº§è·¯çº¿å›¾
- [ClickHouse è¡¨ç»“æ„](./clickhouse-schema.md) - äº‹ä»¶/æ”¯ä»˜ä¸æŒ‰å¤©èšåˆè¡¨è®¾è®¡

### ğŸš€ å®æ–½æŒ‡å—
- [å¿«é€Ÿå¼€å§‹](./quick-start.md) - 5åˆ†é’Ÿä¸Šæ‰‹æŒ‡å—
- [æœ€ä½³å®è·µ](./best-practices.md) - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®
- [æ•…éšœæ’é™¤](./troubleshooting.md) - å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

### ğŸ“Š æŒ‡æ ‡å‚è€ƒ
- [æŒ‡æ ‡è¯å…¸](./metrics-dictionary.md) - æ‰€æœ‰æŒ‡æ ‡çš„è¯¦ç»†å®šä¹‰
- [APIå‚è€ƒ](./api-reference.md) - å®Œæ•´çš„APIæ–‡æ¡£
- [SDKå‚è€ƒ](./sdk-reference.md) - å¤šè¯­è¨€SDKä½¿ç”¨æŒ‡å—

## ğŸ® æ”¯æŒçš„æ¸¸æˆç±»å‹

| æ¸¸æˆç±»å‹ | æ ¸å¿ƒæŒ‡æ ‡ | ç‰¹æ®Šéœ€æ±‚ | æ–‡æ¡£é“¾æ¥ |
|---------|---------|---------|---------|
| **ä¼‘é—²æ¸¸æˆ** | ç•™å­˜ç‡ã€å¹¿å‘Šæ”¶ç›Šã€Sessionæ—¶é•¿ | ç¢ç‰‡åŒ–æŒ‡æ ‡ã€ä¸Šæ‰‹éš¾åº¦ | [ä¼‘é—²æ¸¸æˆæŒ‡æ ‡](./casual-games.md) |
| **é‡åº¦RPG** | æˆé•¿ä½“ç³»ã€ä»˜è´¹æ·±åº¦ã€ç¤¾äº¤ç²˜æ€§ | å…»æˆæŠ•å…¥åº¦ã€æ•°å€¼å¹³è¡¡ | [RPGæ¸¸æˆæŒ‡æ ‡](./rpg-games.md) |
| **ç«æŠ€æ¸¸æˆ** | ç«æŠ€å¹³è¡¡ã€æŠ€èƒ½æˆé•¿ã€åŒ¹é…è´¨é‡ | ä½œå¼Šæ£€æµ‹ã€ç½‘ç»œä½“éªŒ | [ç«æŠ€æ¸¸æˆæŒ‡æ ‡](./competitive-games.md) |
| **ç­–ç•¥æ¸¸æˆ** | ç­–ç•¥æ·±åº¦ã€æ—¶é—´æŠ•å…¥ã€METAæ¼”åŒ– | å†³ç­–åˆ†æã€å­¦ä¹ æ›²çº¿ | [ç­–ç•¥æ¸¸æˆæŒ‡æ ‡](./strategy-games.md) |

## ğŸ”§ æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph "é‡‡é›†å±‚ï¼ˆå…¬ç½‘/DMZ + å†…ç½‘ï¼‰"
        A[æ¸¸æˆå®¢æˆ·ç«¯] --> I[Analytics Ingestion<br/>HTTP/JSON+ç­¾å+é™æµ]
        C[æ¸¸æˆæœåŠ¡å™¨] --> D[OTel SDK/Agent]
    end

    subgraph "å¤„ç†å±‚ï¼ˆå¯ç»„åˆï¼‰"
        D --> E[OTel Collector<br/>OTLP/gRPC|HTTP]
        I --> R[MQ: Redis/Kafka]
        E --> R
        R --> W[Analytics Worker<br/>æ¸…æ´—/èšåˆ/å…¥åº“]
    end

    subgraph "å­˜å‚¨å±‚ï¼ˆå†…ç½‘ï¼‰"
        W --> H[ClickHouse<br/>äº‹ä»¶/èšåˆè¡¨]
        E --> P[Prometheus<br/>æŒ‡æ ‡]
        E --> JG[Jaeger/Tempo<br/>é“¾è·¯]
    end

    subgraph "åº”ç”¨å±‚"
        H --> K[åˆ†ææŠ¥è¡¨/Grafana]
        P --> K
        JG --> K
    end
```

## ğŸŒŸ æ ¸å¿ƒä¼˜åŠ¿

### æ ‡å‡†åŒ–æ•°æ®æ¨¡å‹
- åŸºäº OpenTelemetry è¡Œä¸šæ ‡å‡†
- ç»Ÿä¸€çš„ Tracesã€Metricsã€Logs æ•°æ®æ ¼å¼
- å¤šè¯­è¨€SDKæ”¯æŒ (Go/Java/C++/JavaScript/Python)

### çµæ´»çš„éƒ¨ç½²æ–¹å¼
- äº‘åŸç”Ÿæ¶æ„ï¼Œæ”¯æŒå®¹å™¨åŒ–éƒ¨ç½²
- å¤šç§åç«¯å­˜å‚¨é€‰æ‹© (ClickHouse/Prometheus/Elasticsearch)
- æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒé«˜å¹¶å‘æ•°æ®å¤„ç†

### æ¸¸æˆä¸šåŠ¡æ·±åº¦ä¼˜åŒ–
- æ¸¸æˆç‰¹æœ‰çš„è¯­ä¹‰æ ‡å‡†åŒ–
- å®Œæ•´çš„ç”¨æˆ·è¡Œä¸ºé“¾è·¯è¿½è¸ª
- å®æ—¶æ€§èƒ½ç›‘æ§å’Œå¼‚å¸¸æ£€æµ‹

## ğŸ“ˆ ä¸šåŠ¡ä»·å€¼

### è¿è¥ä¼˜åŒ–
- **ç”¨æˆ·è·å–æˆæœ¬é™ä½ 15-25%** - ç²¾å‡†æ¸ é“æŠ•æ”¾åˆ†æ
- **ç”¨æˆ·ç•™å­˜æå‡ 10-15%** - æµå¤±é¢„è­¦å’Œå¹²é¢„
- **æ´»åŠ¨ROIæå‡ 30-50%** - æ•°æ®é©±åŠ¨çš„æ´»åŠ¨ä¼˜åŒ–

### æŠ€æœ¯æå‡
- **å¼€å‘æ•ˆç‡æå‡ 70%** - æ ‡å‡†åŒ–SDKå’Œå·¥å…·é“¾
- **æ•…éšœå®šä½é€Ÿåº¦æå‡ 80%** - åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
- **è¿ç»´æˆæœ¬é™ä½ 50%** - è‡ªåŠ¨åŒ–ç›‘æ§å’Œå‘Šè­¦

## ğŸŒ å…¬ç½‘é‡‡é›†å…¥å£ï¼ˆAnalytics Ingestionï¼‰

é¢å‘â€œæ¸¸æˆå®¢æˆ·ç«¯â€çš„äº‹ä»¶ä¸ŠæŠ¥ï¼Œæ¨èä½¿ç”¨ç‹¬ç«‹çš„ Analytics Ingestion æœåŠ¡ï¼ˆä¸æ§åˆ¶é¢è§£è€¦ï¼‰ï¼Œå…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š
- å®‰å…¨ï¼šå‰ç½® CDN/WAFã€åŸºäº HMAC-SHA256 çš„ç­¾åæ ¡éªŒã€æ—¶é—´æˆ³+nonce é˜²é‡æ”¾ã€æŒ‰æ¸¸æˆ/ç¯å¢ƒé™æµ
- å¯é ï¼šå†™å…¥ MQï¼ˆRedis Streams/Kafkaï¼‰ï¼Œæ¶ˆè´¹å¤±è´¥å¯é‡æ”¾ï¼›æ”¯æŒ MaxLen èƒŒå‹
- çµæ´»ï¼šå®Œå…¨ä¸šåŠ¡äº‹ä»¶æ¨¡å‹ï¼ˆlogin/progression/purchaseâ€¦ï¼‰ï¼Œå­—æ®µç™½åå•ä¸ç°åº¦å¼€å…³

æœ€å°åŒ–è½åœ°ç¤ºä¾‹ï¼ˆå·²åœ¨æœ¬ä»“åº“æä¾› cmd/analytics-ingestï¼‰ï¼š
- ç«¯ç‚¹ï¼š
  - POST /api/ingest/eventsï¼ˆé€šç”¨äº‹ä»¶æ•°ç»„ï¼‰
  - POST /api/ingest/paymentsï¼ˆæ”¯ä»˜äº‹ä»¶æ•°ç»„ï¼‰
- è®¤è¯ä¸é˜²é‡æ”¾ï¼ˆè¯·æ±‚å¤´ï¼‰ï¼š
  - X-Timestampï¼šUnix ç§’ï¼›ä¸æœåŠ¡å™¨å…è®¸çš„æ—¶é—´åå·®é»˜è®¤ 300s
  - X-Nonceï¼šå®¢æˆ·ç«¯ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
  - X-Signatureï¼šBase64(HMAC-SHA256(secret, `${timestamp}\n${nonce}\n${sha256(body)}`))
  - å…±äº«å¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡ `ANALYTICS_INGEST_SECRET` é…ç½®
- ç¯å¢ƒå˜é‡ï¼š
  - ANALYTICS_MQ_TYPE=redis
  - REDIS_URL=redis://user:pass@host:6379/0
  - ANALYTICS_REDIS_STREAM_EVENTS=analytics:events
  - ANALYTICS_REDIS_STREAM_PAYMENTS=analytics:payments
  - ANALYTICS_INGEST_SECRET=your-secret
  - ANALYTICS_INGEST_SKEW=300ï¼ˆå¯é€‰ï¼Œå…è®¸æ—¶é—´åå·®ç§’ï¼‰

ä¸ OTel Collector çš„å…³ç³»ï¼š
- å®¢æˆ·ç«¯è‹¥ä¸ä¾¿å¼•å…¥ OTLPï¼Œå¯ç›´æ¥ç”¨ Ingestionï¼ˆHTTP/JSONï¼‰
- æœåŠ¡ç«¯/Agent çš„ traces/metrics å»ºè®®èµ° OTel Collectorï¼›ä¸šåŠ¡äº‹ä»¶å¯é€šè¿‡ SDK/Bridge å†™ MQ
- äºŒè€…å¯å¹¶å­˜ï¼Œæœ€ç»ˆåœ¨ ClickHouse/Grafana æ±‡èš

## ğŸš€ å¿«é€Ÿå¼€å§‹

1. **ç¯å¢ƒå‡†å¤‡**
   ```bash
   # å…‹éš†é¡¹ç›®
   git clone https://github.com/cuihairu/croupier.git
   cd croupier

   # å¯åŠ¨åŸºç¡€æœåŠ¡
   docker-compose up -d clickhouse redis
   ```

2. **å¯åŠ¨åˆ†ææœåŠ¡**
   ```bash
   # ç¼–è¯‘å¹¶å¯åŠ¨
   make build
   ./bin/croupier server --config configs/server.yaml
   ```

3. **æŸ¥çœ‹åˆ†æé¢æ¿**
   ```
   æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost:8080/analytics
   ```

## ğŸ“ è·å–æ”¯æŒ

- **æ–‡æ¡£é—®é¢˜**: [æ–‡æ¡£Issue](https://github.com/cuihairu/croupier/issues)
- **æŠ€æœ¯è®¨è®º**: [GitHub Discussions](https://github.com/cuihairu/croupier/discussions)
- **BugæŠ¥å‘Š**: [Bug Report Template](https://github.com/cuihairu/croupier/issues/new?template=bug_report.md)

---

> ğŸ’¡ **æç¤º**: å»ºè®®å…ˆé˜…è¯»[æ¸¸æˆæŒ‡æ ‡å…¨æ™¯å›¾](./game-metrics-overview.md)äº†è§£æ•´ä½“æ¡†æ¶ï¼Œå†æ ¹æ®æ‚¨çš„æ¸¸æˆç±»å‹é€‰æ‹©å¯¹åº”çš„å®æ–½æ–¹æ¡ˆã€‚
