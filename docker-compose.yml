version: '3.9'

services:
  # ================================
  # 数据库服务
  # ================================

  # PostgreSQL 数据库
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:15-alpine}
    container_name: croupier-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: croupier
      POSTGRES_USER: croupier
      POSTGRES_PASSWORD: croupier_dev_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - croupier-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U croupier -d croupier"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: ${REDIS_IMAGE:-redis:7-alpine}
    container_name: croupier-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - croupier-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ClickHouse 分析型数据库（本地开发）
  clickhouse:
    image: ${CLICKHOUSE_IMAGE:-clickhouse/clickhouse-server:23}
    container_name: croupier-clickhouse
    restart: unless-stopped
    environment:
      # 默认用户/密码（生产请改强）
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-analytics}
    ports:
      - "8123:8123"   # HTTP
      - "9000:9000"   # Native
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
      - ./configs/clickhouse/initdb:/docker-entrypoint-initdb.d:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8123/?query=SELECT%201 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - croupier-network

  # ================================
  # Croupier 服务
  # ================================

  edge:
    build:
      context: .
      dockerfile: Dockerfile.edge
      args:
        GO_IMAGE: ${GO_IMAGE:-golang:1.24}
        RUNTIME_IMAGE: ${RUNTIME_IMAGE:-gcr.io/distroless/static:nonroot}
    command: ["edge", "--addr", ":9443", "--http_addr", ":9080", "--games_config", "/app/configs/games.json", "--cert", "/app/configs/dev/server.crt", "--key", "/app/configs/dev/server.key", "--ca", "/app/configs/dev/ca.crt"]
    ports: ["9443:9443", "9080:9080"]
    networks:
      - croupier-network

  server:
    build:
      context: .
      dockerfile: Dockerfile.server
      args:
        GO_IMAGE: ${GO_IMAGE:-golang:1.24}
        RUNTIME_IMAGE: ${RUNTIME_IMAGE:-gcr.io/distroless/static:nonroot}
        # Optional: include sqlite support by setting BUILD_TAGS to "pg sqlite"
        BUILD_TAGS: ${SERVER_BUILD_TAGS:-"pg ip2location"}
    environment:
      # 数据库配置
      DATABASE_URL: postgres://croupier:croupier_dev_password@postgres:5432/croupier?sslmode=disable
      REDIS_URL: redis://redis:6379/0
      # GeoIP (可选，已内置 configs 下的 LITE BIN 文件，默认启用)
      IP2LOCATION_BIN_PATH: /app/configs/IP2LOCATION-LITE-DB3.BIN
      IP2LOCATION_BIN_PATH_V6: /app/configs/IP2LOCATION-LITE-DB3.IPV6.BIN
      GEOIP_TIMEOUT_MS: 800
      # ClickHouse（可选）
      CLICKHOUSE_DSN: ${CLICKHOUSE_DSN:-clickhouse://clickhouse:9000/analytics?dial_timeout=5s&compress=true}
    command: ["server", "--addr", ":8443", "--http_addr", ":8080", "--edge_addr", "edge:9443", "--rbac_config", "/app/configs/rbac.json", "--games_config", "/app/configs/games.json", "--users_config", "/app/configs/users.json", "--jwt_secret", "change-me", "--cert", "/app/configs/dev/server.crt", "--key", "/app/configs/dev/server.key", "--ca", "/app/configs/dev/ca.crt"]
    ports: ["8443:8443", "18080:8080"]
    depends_on:
      edge:
        condition: service_started
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    networks:
      - croupier-network

  agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
      args:
        GO_IMAGE: ${GO_IMAGE:-golang:1.24}
        RUNTIME_IMAGE: ${RUNTIME_IMAGE:-gcr.io/distroless/static:nonroot}
    command: ["agent", "--local_addr", ":19090", "--http_addr", ":19091", "--server_addr", "edge:9443", "--game_id", "default", "--env", "dev", "--cert", "/app/configs/dev/agent.crt", "--key", "/app/configs/dev/agent.key", "--ca", "/app/configs/dev/ca.crt"]
    ports: ["19090:19090", "19091:19091"]
    depends_on: [edge]
    networks:
      - croupier-network

  # Web UI (Umi Max) served by Nginx; proxies /api to server:8080
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:20-alpine}
        NGINX_IMAGE: ${NGINX_IMAGE:-nginx:alpine}
        # Optional domestic registry for npm (e.g. https://registry.npmmirror.com)
        NPM_REGISTRY: ${NPM_REGISTRY:-}
    ports: ["8000:80"]
    depends_on:
      - server
    networks:
      - croupier-network

  # ================================
  # 流式计算（可选：profiles: [stream]）
  # ================================

  # Kafka (KRaft 模式，免 Zookeeper)
  kafka:
    image: ${KAFKA_IMAGE:-bitnami/kafka:3.6}
    container_name: croupier-kafka
    restart: unless-stopped
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_LOG_DIRS=/bitnami/kafka/data
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      # 调整内存（本地 Dev）
      - KAFKA_HEAP_OPTS=-Xms256m -Xmx512m
    volumes:
      - kafka_data:/bitnami/kafka
    ports:
      - "9092:9092"
    networks:
      - croupier-network
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo >/dev/tcp/127.0.0.1/9092' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    profiles:
      - stream

  # Flink JobManager
  flink-jobmanager:
    image: ${FLINK_IMAGE:-flink:1.18}
    container_name: croupier-flink-jobmanager
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 2
        parallelism.default: 2
    ports:
      - "8081:8081" # Flink Web UI
    networks:
      - croupier-network
    profiles:
      - stream

  # Flink TaskManager
  flink-taskmanager:
    image: ${FLINK_IMAGE:-flink:1.18}
    container_name: croupier-flink-taskmanager
    depends_on:
      - flink-jobmanager
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 2
        parallelism.default: 2
    networks:
      - croupier-network
    profiles:
      - stream

  # Analytics Worker (Redis Streams -> ClickHouse) - optional
  analytics-worker:
    build:
      context: .
      dockerfile: Dockerfile.server
      args:
        GO_IMAGE: ${GO_IMAGE:-golang:1.24}
        RUNTIME_IMAGE: ${RUNTIME_IMAGE:-gcr.io/distroless/static:nonroot}
    command: ["analytics-worker"]
    environment:
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      ANALYTICS_REDIS_STREAM_EVENTS: ${ANALYTICS_REDIS_STREAM_EVENTS:-analytics:events}
      ANALYTICS_REDIS_STREAM_PAYMENTS: ${ANALYTICS_REDIS_STREAM_PAYMENTS:-analytics:payments}
      CLICKHOUSE_DSN: ${CLICKHOUSE_DSN:-clickhouse://clickhouse:9000/analytics}
      WORKER_GROUP: ${WORKER_GROUP:-analytics-worker}
    depends_on:
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    networks:
      - croupier-network
    profiles:
      - stream

  # ================================
  # 管理工具 (可选)
  # ================================

  # PostgreSQL 管理界面
  pgadmin:
    image: ${PGADMIN_IMAGE:-dpage/pgadmin4:latest}
    container_name: croupier-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@croupier.local
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "8082:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - croupier-network
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - tools

  # Redis 管理界面
  redis-commander:
    image: ${REDIS_CMD_IMAGE:-rediscommander/redis-commander:latest}
    container_name: croupier-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: redis:redis:6379
      HTTP_USER: admin
      HTTP_PASSWORD: admin123
    ports:
      - "8083:8081"
    networks:
      - croupier-network
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - tools

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  pgadmin_data:
    driver: local
  clickhouse_data:
    driver: local
  clickhouse_logs:
    driver: local
  kafka_data:
    driver: local

networks:
  croupier-network:
    driver: bridge
