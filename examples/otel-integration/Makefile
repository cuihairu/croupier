# OpenTelemetry é›†æˆç¤ºä¾‹ Makefile

.PHONY: help build start stop demo test clean logs status

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# å˜é‡å®šä¹‰
GO_VERSION := 1.24
BINARY_DIR := bin
SERVER_BINARY := $(BINARY_DIR)/server
CLIENT_BINARY := $(BINARY_DIR)/client
SIMULATOR_BINARY := $(BINARY_DIR)/game-simulator

# å¸®åŠ©ä¿¡æ¯
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "OpenTelemetry é›†æˆç¤ºä¾‹ - å¯ç”¨å‘½ä»¤ï¼š"
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "å¿«é€Ÿå¼€å§‹ï¼š"
	@echo "  1. make build    # æ„å»ºåº”ç”¨ç¨‹åº"
	@echo "  2. make start    # å¯åŠ¨å®Œæ•´ç¯å¢ƒ"
	@echo "  3. make demo     # è¿è¡Œæ¼”ç¤º"
	@echo "  4. make test     # è¿è¡Œæµ‹è¯•"
	@echo "  5. make stop     # åœæ­¢æ‰€æœ‰æœåŠ¡"

# æ„å»ºç›¸å…³
deps: ## ä¸‹è½½ä¾èµ–
	@echo "ğŸ”„ ä¸‹è½½ Go ä¾èµ–..."
	go mod download
	go mod tidy

build: deps $(SERVER_BINARY) $(CLIENT_BINARY) $(SIMULATOR_BINARY) build-enhanced ## æ„å»ºæ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
	@echo "âœ… æ‰€æœ‰åº”ç”¨ç¨‹åºæ„å»ºå®Œæˆ"

$(BINARY_DIR):
	@mkdir -p $(BINARY_DIR)

$(SERVER_BINARY): $(BINARY_DIR) cmd/server/main.go internal/telemetry/*.go internal/game/*.go
	@echo "ğŸ”¨ æ„å»ºæ¸¸æˆæœåŠ¡å™¨..."
	go build -o $(SERVER_BINARY) cmd/server/main.go

$(CLIENT_BINARY): $(BINARY_DIR) cmd/client/main.go internal/telemetry/*.go
	@echo "ğŸ”¨ æ„å»ºæ¸¸æˆå®¢æˆ·ç«¯..."
	go build -o $(CLIENT_BINARY) cmd/client/main.go

$(SIMULATOR_BINARY): $(BINARY_DIR) cmd/game-simulator/main.go internal/telemetry/*.go internal/game/*.go
	@echo "ğŸ”¨ æ„å»ºæ¸¸æˆæ¨¡æ‹Ÿå™¨..."
	go build -o $(SIMULATOR_BINARY) cmd/game-simulator/main.go

build-enhanced: $(BINARY_DIR) cmd/enhanced-client/main.go internal/telemetry/*.go ## æ„å»ºå¢å¼ºå®¢æˆ·ç«¯
	@echo "ğŸ”¨ æ„å»ºå¢å¼ºå®¢æˆ·ç«¯ï¼ˆå«å®Œæ•´åˆ†ææŒ‡æ ‡ï¼‰..."
	go build -o $(BINARY_DIR)/enhanced-client cmd/enhanced-client/main.go

# å¼€å‘ç›¸å…³
dev-deps: ## å®‰è£…å¼€å‘ä¾èµ–
	@echo "ğŸ”§ å®‰è£…å¼€å‘ä¾èµ–..."
	@which docker > /dev/null || (echo "âŒ Docker æœªå®‰è£…" && exit 1)
	@which docker-compose > /dev/null || (echo "âŒ Docker Compose æœªå®‰è£…" && exit 1)
	@which curl > /dev/null || (echo "âŒ curl æœªå®‰è£…" && exit 1)
	@echo "âœ… å¼€å‘ä¾èµ–æ£€æŸ¥å®Œæˆ"

fmt: ## æ ¼å¼åŒ–ä»£ç 
	@echo "ğŸ¨ æ ¼å¼åŒ– Go ä»£ç ..."
	go fmt ./...

lint: ## ä»£ç æ£€æŸ¥
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	@which golangci-lint > /dev/null || (echo "å®‰è£… golangci-lint..." && go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest)
	golangci-lint run

# è¿è¡Œç›¸å…³
start: build dev-deps ## å¯åŠ¨å®Œæ•´çš„ OpenTelemetry ç¤ºä¾‹ç¯å¢ƒ
	@echo "ğŸš€ å¯åŠ¨ OpenTelemetry é›†æˆç¤ºä¾‹..."
	./scripts/start.sh start

stop: ## åœæ­¢æ‰€æœ‰æœåŠ¡
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	./scripts/start.sh stop

restart: stop start ## é‡å¯æ‰€æœ‰æœåŠ¡

demo: ## è¿è¡Œäº¤äº’å¼æ¼”ç¤º
	@echo "ğŸ­ è¿è¡Œæ¼”ç¤º..."
	./scripts/demo.sh

status: ## æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
	./scripts/start.sh status

logs: ## æ˜¾ç¤ºæœåŠ¡æ—¥å¿—
	@echo "ğŸ“‹ æœåŠ¡æ—¥å¿—ï¼š"
	./scripts/start.sh logs

# æµ‹è¯•ç›¸å…³
test: build ## è¿è¡Œå•å…ƒæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	go test -race -coverprofile=coverage.out ./...

test-integration: ## è¿è¡Œé›†æˆæµ‹è¯•
	@echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
	@echo "è¯·å…ˆå¯åŠ¨æœåŠ¡: make start"
	go test -tags=integration ./test/...

test-client-analytics: ## æµ‹è¯•å®¢æˆ·ç«¯åˆ†ææŒ‡æ ‡å®Œæ•´æ€§
	@echo "ğŸ”¬ æµ‹è¯•å®¢æˆ·ç«¯åˆ†ææŒ‡æ ‡..."
	./scripts/test-client-analytics.sh 60 3

test-client-analytics-extended: ## æ‰©å±•å®¢æˆ·ç«¯åˆ†ææµ‹è¯•ï¼ˆ5åˆ†é’Ÿï¼Œ10å®¢æˆ·ç«¯ï¼‰
	@echo "ğŸ”¬ æ‰©å±•å®¢æˆ·ç«¯åˆ†ææµ‹è¯•..."
	./scripts/test-client-analytics.sh 300 10

load-test: ## è¿è¡Œè´Ÿè½½æµ‹è¯•ï¼ˆé»˜è®¤10ç”¨æˆ·60ç§’ï¼‰
	@echo "ğŸ”¥ è¿è¡Œè´Ÿè½½æµ‹è¯•..."
	./scripts/load-test.sh 10 60s

load-test-heavy: ## è¿è¡Œé‡è´Ÿè½½æµ‹è¯•ï¼ˆ50ç”¨æˆ·5åˆ†é’Ÿï¼‰
	@echo "ğŸ’¥ è¿è¡Œé‡è´Ÿè½½æµ‹è¯•..."
	./scripts/load-test.sh 50 300s

coverage: test ## ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	go tool cover -html=coverage.out -o coverage.html
	@echo "ğŸ“‹ è¦†ç›–ç‡æŠ¥å‘Š: coverage.html"

# è¿ç»´ç›¸å…³
docker-build: ## æ„å»º Docker é•œåƒ
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	docker build -t croupier-otel-server:latest -f docker/Dockerfile.server .
	docker build -t croupier-otel-client:latest -f docker/Dockerfile.client .
	docker build -t croupier-otel-simulator:latest -f docker/Dockerfile.simulator .

docker-push: docker-build ## æ¨é€ Docker é•œåƒ
	@echo "ğŸ“¤ æ¨é€ Docker é•œåƒ..."
	@echo "è¯·é…ç½® Docker registry åœ°å€"

backup: ## å¤‡ä»½é…ç½®å’Œæ•°æ®
	@echo "ğŸ’¾ å¤‡ä»½é…ç½®å’Œæ•°æ®..."
	@mkdir -p backups/$(shell date +%Y%m%d_%H%M%S)
	@tar -czf backups/$(shell date +%Y%m%d_%H%M%S)/configs.tar.gz configs/
	@echo "âœ… å¤‡ä»½å®Œæˆ: backups/$(shell date +%Y%m%d_%H%M%S)/"

# æ¸…ç†ç›¸å…³
clean: ## æ¸…ç†æ„å»ºäº§ç‰©
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©..."
	rm -rf $(BINARY_DIR)
	rm -f coverage.out coverage.html
	rm -rf test-results

clean-docker: ## æ¸…ç† Docker èµ„æº
	@echo "ğŸ³ æ¸…ç† Docker èµ„æº..."
	docker-compose down -v --remove-orphans
	docker system prune -f

clean-all: clean clean-docker ## å®Œå…¨æ¸…ç†

# ç›‘æ§ç›¸å…³
monitor: ## æ‰“å¼€ç›‘æ§é¢æ¿
	@echo "ğŸ“Š æ‰“å¼€ç›‘æ§é¢æ¿..."
	@echo "Grafana: http://localhost:3000 (admin/admin)"
	@echo "Jaeger: http://localhost:16686"
	@echo "Prometheus: http://localhost:9090"
	@echo "AlertManager: http://localhost:9093"
	@if command -v open >/dev/null 2>&1; then \
		open http://localhost:3000; \
	elif command -v xdg-open >/dev/null 2>&1; then \
		xdg-open http://localhost:3000; \
	fi

health-check: ## æ£€æŸ¥æ‰€æœ‰æœåŠ¡å¥åº·çŠ¶æ€
	@echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
	@curl -f -s http://localhost:8080/health > /dev/null && echo "âœ… æ¸¸æˆæœåŠ¡å™¨å¥åº·" || echo "âŒ æ¸¸æˆæœåŠ¡å™¨ä¸å¥åº·"
	@curl -f -s http://localhost:3000/api/health > /dev/null && echo "âœ… Grafana å¥åº·" || echo "âŒ Grafana ä¸å¥åº·"
	@curl -f -s http://localhost:16686/ > /dev/null && echo "âœ… Jaeger å¥åº·" || echo "âŒ Jaeger ä¸å¥åº·"
	@curl -f -s http://localhost:9090/-/healthy > /dev/null && echo "âœ… Prometheus å¥åº·" || echo "âŒ Prometheus ä¸å¥åº·"

# æ–‡æ¡£ç›¸å…³
docs: ## ç”Ÿæˆæ–‡æ¡£
	@echo "ğŸ“š ç”Ÿæˆæ–‡æ¡£..."
	@echo "å½“å‰æ–‡æ¡£ä½ç½®ï¼š"
	@echo "  - README.md: ä¸»è¦æ–‡æ¡£"
	@echo "  - configs/: é…ç½®æ–‡ä»¶æ–‡æ¡£"
	@echo "  - scripts/: è„šæœ¬ä½¿ç”¨è¯´æ˜"

# æç®€é›†æˆç›¸å…³
simple-game: build-simple ## è¿è¡Œæç®€æ¸¸æˆæœåŠ¡å™¨ç¤ºä¾‹ï¼ˆæ¼”ç¤º5åˆ†é’Ÿé›†æˆï¼‰
	@echo "ğŸ® è¿è¡Œæç®€æ¸¸æˆæœåŠ¡å™¨ç¤ºä¾‹..."
	./bin/simple-game-server

build-simple: $(BINARY_DIR) cmd/simple-game-server/main.go simple_analytics.go ## æ„å»ºæç®€æ¸¸æˆæœåŠ¡å™¨
	@echo "ğŸ”¨ æ„å»ºæç®€æ¸¸æˆæœåŠ¡å™¨..."
	go build -o $(BINARY_DIR)/simple-game-server cmd/simple-game-server/main.go

demo-simple: ## å®Œæ•´æ¼”ç¤ºï¼šå¯åŠ¨æœåŠ¡+è¿è¡Œæç®€æ¸¸æˆï¼ˆä¸€é”®ä½“éªŒï¼‰
	@echo "ğŸš€ å¯åŠ¨å®Œæ•´æç®€æ¼”ç¤º..."
	@echo "1. æ£€æŸ¥Croupier Serveræ˜¯å¦è¿è¡Œ..."
	@curl -f -s http://localhost:8080/health > /dev/null || (echo "âŒ è¯·å…ˆå¯åŠ¨Croupier Server" && exit 1)
	@echo "2. å¯åŠ¨æç®€æ¸¸æˆæœåŠ¡å™¨..."
	$(MAKE) simple-game
	@echo "3. æŸ¥çœ‹Analyticsæ•°æ®..."
	@echo "è®¿é—® http://localhost:3000 æŸ¥çœ‹Grafanaä»ªè¡¨æ¿"

# å¼€å‘è¾…åŠ©
dev-server: build ## å¯åŠ¨å¼€å‘æ¨¡å¼æœåŠ¡å™¨ï¼ˆä»…æœåŠ¡å™¨ï¼Œæ— å®¹å™¨ï¼‰
	@echo "ğŸ”§ å¯åŠ¨å¼€å‘æ¨¡å¼æœåŠ¡å™¨..."
	@export OTEL_SERVICE_NAME=game-server && \
	export OTEL_SERVICE_VERSION=dev && \
	export OTEL_ENVIRONMENT=development && \
	export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318 && \
	export GAME_ID=dev-game && \
	export OTEL_SAMPLING_RATIO=1.0 && \
	./$(SERVER_BINARY)

dev-client: build ## è¿è¡Œå¼€å‘æ¨¡å¼å®¢æˆ·ç«¯
	@echo "ğŸ”§ è¿è¡Œå¼€å‘æ¨¡å¼å®¢æˆ·ç«¯..."
	@export OTEL_SERVICE_NAME=game-client && \
	export OTEL_SERVICE_VERSION=dev && \
	export OTEL_ENVIRONMENT=development && \
	export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318 && \
	./$(CLIENT_BINARY)

watch: ## ç›‘æ§æ–‡ä»¶å˜åŒ–å¹¶é‡æ–°æ„å»º
	@echo "ğŸ‘€ ç›‘æ§æ–‡ä»¶å˜åŒ–..."
	@which fswatch > /dev/null || (echo "è¯·å®‰è£… fswatch: brew install fswatch" && exit 1)
	fswatch -o cmd/ internal/ | xargs -n1 -I{} make build

# æ€§èƒ½åˆ†æ
profile: ## è¿è¡Œæ€§èƒ½åˆ†æ
	@echo "ğŸ“ˆ è¿è¡Œæ€§èƒ½åˆ†æ..."
	go tool pprof -http=:8081 http://localhost:1777/debug/pprof/profile
	@echo "æ€§èƒ½åˆ†æç•Œé¢: http://localhost:8081"

bench: ## è¿è¡ŒåŸºå‡†æµ‹è¯•
	@echo "âš¡ è¿è¡ŒåŸºå‡†æµ‹è¯•..."
	go test -bench=. -benchmem ./...

# ä¾¿æ·åˆ«å
up: start     ## åˆ«åï¼šå¯åŠ¨æœåŠ¡
down: stop    ## åˆ«åï¼šåœæ­¢æœåŠ¡
ps: status    ## åˆ«åï¼šæŸ¥çœ‹çŠ¶æ€
tail: logs    ## åˆ«åï¼šæŸ¥çœ‹æ—¥å¿—

# éªŒè¯ç¯å¢ƒ
verify: ## éªŒè¯ç¯å¢ƒå’Œé…ç½®
	@echo "âœ… éªŒè¯ç¯å¢ƒ..."
	@go version | grep -q "go1.24" || (echo "âš ï¸ å»ºè®®ä½¿ç”¨ Go 1.24" && go version)
	@which docker > /dev/null && echo "âœ… Docker å¯ç”¨" || echo "âŒ Docker ä¸å¯ç”¨"
	@which docker-compose > /dev/null && echo "âœ… Docker Compose å¯ç”¨" || echo "âŒ Docker Compose ä¸å¯ç”¨"
	@which curl > /dev/null && echo "âœ… curl å¯ç”¨" || echo "âŒ curl ä¸å¯ç”¨"
	@[ -f configs/otel-collector.yaml ] && echo "âœ… OTel Collector é…ç½®å­˜åœ¨" || echo "âŒ OTel Collector é…ç½®ç¼ºå¤±"
	@[ -f docker-compose.yml ] && echo "âœ… Docker Compose é…ç½®å­˜åœ¨" || echo "âŒ Docker Compose é…ç½®ç¼ºå¤±"